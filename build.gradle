buildscript {
  dependencies {
    classpath 'org.asciidoctor:asciidoctorj-epub3:1.5.0-alpha.6'
    classpath 'org.asciidoctor:asciidoctorj-pdf:1.5.0-alpha.15'
    classpath 'org.asciidoctor:asciidoctorj-diagram:1.5.4'
  }
}

plugins {
  id 'org.asciidoctor.convert' version '1.5.3'
  id 'com.gradle.plugin-publish' version '0.9.10' apply false
}

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'eclipse'
apply plugin: 'org.asciidoctor.convert'

version = '1.0.0'

asciidoctorj {
  version = '1.5.5'
}

asciidoctor {
  backends 'html5', 'pdf' //, 'epub3', 'docbook'
  // enable the Asciidoctor Diagram extension
  requires 'asciidoctor-diagram'
  separateOutputDirs false
  attributes  \
         'build-gradle': file('build.gradle'),
    'sourcedir': project.sourceSets.main.java.srcDirs[0],
    //'pdf-stylesdir': 'theme',
    //'pdf-style': 'c7',
    'endpoint-url': 'http://example.org',
    'source-highlighter': 'coderay',
    'outdir': outputDir.absolutePath,
    'buildDate': new java.text.SimpleDateFormat("dd-MMM-yyyy").format(new Date()),
    'toc': 'left',
    'icons': 'font',
    'setanchors': '',
    'idprefix': '',
    'idseparator': '-',
    'docinfo1': '',
    'allow-uri-read': true
}

ext {
    currentBranch = System.getenv('ANGEL_BRANCH') ?: 'not-on-angel-ci'
    pushDocs = currentBranch.matches(~/^master|development-.+|maintenance-.+$/)
}

gitPublish {
    repoUri = gitHubRepoUri
    branch = pagesBranch

    contents {
        into currentBranch
        from rootProject.tasks.combineDocs
    }

    preserve {
        include '**'
        exclude "${currentBranch}/**"
    }

    commitMessage = "Updating SNAPSHOT documentation for ${currentBranch} at ${version}"
}

task publishDocs {
    if(pushDocs) {
        dependsOn gitPublishPush
    }
    doFirst {
        logger.info "${currentBranch} is ${pushDocs ? 'a match. Push attempted' : 'not a match. Push skipped.'}"
    }
}